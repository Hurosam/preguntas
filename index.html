<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Preguntas Aleatorias</title>
    
    <!-- Librerías Externas con múltiples CDNs de respaldo -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Intentar cargar docx desde múltiples CDNs -->
    <script>
        // Función para cargar docx con fallbacks
        function loadDocxLibrary() {
            const cdnUrls = [
                'https://unpkg.com/docx@7.8.2/build/index.js',
                'https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.js',
                'https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/index.min.js'
            ];
            
            let currentIndex = 0;
            
            function tryLoadScript() {
                if (currentIndex >= cdnUrls.length) {
                    console.error('No se pudo cargar la biblioteca docx desde ningún CDN');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdnUrls[currentIndex];
                
                script.onload = function() {
                    console.log('Biblioteca docx cargada desde:', cdnUrls[currentIndex]);
                };
                
                script.onerror = function() {
                    console.warn('Falló la carga desde:', cdnUrls[currentIndex]);
                    currentIndex++;
                    tryLoadScript();
                };
                
                document.head.appendChild(script);
            }
            
            tryLoadScript();
        }
        
        // Cargar la biblioteca docx
        loadDocxLibrary();
    </script>
    
    <!-- Estilos locales -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Todo el contenido del body va aquí -->
    <div class="container">
        <h1>🎯 Generador de Preguntas</h1>
        <div class="stats"><strong>📊 Total de preguntas en la base de datos: <span id="totalQuestions">0</span></strong></div>

        <div class="section">
            <h2>📁 Cargar Preguntas desde Archivo</h2>
            <p class="upload-instructions"><strong>Nota:</strong> El archivo debe tener una sola columna. La primera fila debe ser el encabezado (ej. "pregunta") y las siguientes filas deben contener una pregunta cada una.</p>
            <img src="nota.jpg" alt="Ejemplo de formato de archivo" class="guide-image">
            <div class="file-upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                <div id="uploadPrompt">
                    <div style="font-size: 48px; margin-bottom: 10px;">📄</div>
                    <div style="font-size: 16px; color: #667eea; font-weight: 600;">Arrastra un archivo aquí o haz clic para seleccionar</div>
                    <div style="font-size: 14px; color: #888; margin-top: 5px;">Formatos soportados: .xlsx, .xls, .csv</div>
                </div>
            </div>
            <div class="loading" id="loadingFile"><div class="spinner"></div><div id="loadingFileName">Procesando archivo...</div></div>
            <div id="uploadAlertPlaceholder" style="margin-top: 15px;"></div>
        </div>

        <div class="section">
            <h2>✏️ Gestionar Preguntas</h2>
            <div class="form-group">
                <label for="newQuestion">Nueva pregunta:</label>
                <textarea id="newQuestion" placeholder="Escribe tu pregunta aquí..."></textarea>
            </div>
            <button id="addQuestionBtn" class="btn-secondary">➕ Agregar Pregunta</button>
            <button id="clearAllBtn" class="btn-danger">🗑️ Limpiar Todas</button>
            <a href="editar.html" class="button-style btn-edit">✍️ Editar Preguntas</a>
            <button id="exportAllCsvBtn" class="btn-export">📥 Descargar como CSV</button>
            <button id="exportAllExcelBtn" class="btn-export-excel">📥 Descargar como Excel</button>
            <button id="exportAllWordBtn" class="button-style" style="background: linear-gradient(45deg, #2980b9, #3498db);">📥 Descargar como Word</button>
        </div>

        <div class="section">
            <h2>🎲 Generar Preguntas Aleatorias</h2>
            <div class="form-group">
                <label for="questionCount">Número de preguntas a generar:</label>
                <input type="number" id="questionCount" min="1" value="5">
            </div>
            <button id="generateBtn">🚀 Generar Preguntas</button>
        </div>

        <div class="section">
            <h2>📝 Preguntas Generadas</h2>
            <div id="generatedQuestions" class="questions-container"><div style="text-align: center; color: #888; padding: 40px;">No hay preguntas generadas aún.</div></div>
            <div id="generatedActions" class="generated-actions" style="display: none;">
                <button id="exportGenCsvBtn" class="btn-export">Descargar Lista (CSV)</button>
                <button id="exportGenExcelBtn" class="btn-export-excel">Descargar Lista (Excel)</button>
                <button id="exportGenWordBtn" class="button-style" style="background: linear-gradient(45deg, #2980b9, #3498db);">Descargar Lista (Word)</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="customConfirm">
        <div class="modal-content">
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button id="confirmYes" class="btn-danger">Sí, eliminar</button>
                <button id="confirmNo" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Script mejorado con mejor verificación de bibliotecas -->
    <script>
        // Función mejorada para verificar bibliotecas
        function checkLibraries() {
            const requiredLibs = {
                'XLSX': typeof XLSX !== 'undefined',
                'saveAs': typeof saveAs !== 'undefined',
                'docx': typeof docx !== 'undefined' || typeof window.docx !== 'undefined'
            };
            
            const missingLibs = Object.entries(requiredLibs)
                .filter(([name, loaded]) => !loaded)
                .map(([name]) => name);
            
            if (missingLibs.length > 0) {
                console.error('Bibliotecas faltantes:', missingLibs);
                console.log('Estado de las bibliotecas:');
                console.log('XLSX:', typeof XLSX);
                console.log('saveAs:', typeof saveAs);
                console.log('docx:', typeof docx);
                console.log('window.docx:', typeof window.docx);
                
                // Si solo falta docx, permitir que la aplicación funcione sin esa funcionalidad
                if (missingLibs.length === 1 && missingLibs[0] === 'docx') {
                    console.warn('La funcionalidad de Word estará deshabilitada');
                    return true; // Permitir que la app funcione
                }
                
                alert('Error: No se pudieron cargar algunas bibliotecas necesarias. Por favor, recarga la página.');
                return false;
            }
            
            console.log('Todas las bibliotecas cargadas correctamente');
            return true;
        }
        
        // Función para intentar cargar las bibliotecas con reintentos
        function waitForLibraries(callback, maxRetries = 10, currentRetry = 0) {
            if (currentRetry >= maxRetries) {
                console.error('Tiempo de espera agotado para cargar las bibliotecas');
                callback();
                return;
            }
            
            if (checkLibraries()) {
                callback();
            } else {
                setTimeout(() => {
                    waitForLibraries(callback, maxRetries, currentRetry + 1);
                }, 500);
            }
        }
        
        // Esperar a que el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar a que las bibliotecas se carguen
            waitForLibraries(function() {
                // Cargar el script principal
                const script = document.createElement('script');
                script.src = 'index-script.js';
                script.onerror = function() {
                    console.error('Error al cargar el script principal.');
                    alert('Error al cargar el script principal.');
                };
                script.onload = function() {
                    console.log('Script principal cargado correctamente');
                };
                document.body.appendChild(script);
            });
        });
    </script>
</body>
</html>